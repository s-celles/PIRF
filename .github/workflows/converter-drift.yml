name: Converter Drift Check

on:
  push:
    paths:
      - 'converter/**'
      - 'vendor/Rubi/**'
      - 'schemas/**/*.json'
      - '.github/workflows/converter-drift.yml'
  pull_request:
    paths:
      - 'converter/**'
      - 'vendor/Rubi/**'
      - 'schemas/**/*.json'
      - '.github/workflows/converter-drift.yml'
  workflow_dispatch:

jobs:
  drift-check:
    name: Verify converter output matches committed files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: "1"

      - name: Install converter dependencies
        run: julia --project=converter -e 'using Pkg; Pkg.instantiate()'

      - name: Re-run converter (rules)
        run: julia --project=converter converter/scripts/convert.jl --rules

      - name: Re-run converter (tests)
        run: julia --project=converter converter/scripts/convert.jl --tests

      - name: Check for drift
        run: |
          if git diff --exit-code rules/ tests/; then
            echo "No drift detected â€” converter output matches committed files."
          else
            echo "::error::Converter drift detected! Re-run the converter and commit the updated output."
            echo ""
            echo "Changed files:"
            git diff --stat rules/ tests/
            exit 1
          fi
