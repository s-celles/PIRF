{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://domain.org/schemas/v0.1/meta.schema.json",
  "title": "PIRF Meta File",
  "description": "Root meta.json file describing a PIRF rule set: version, load manifest, feature flags, extensions. Conforms to EARS Specification RUBI-PIRF v0.1, §5.2–5.3.",
  "type": "object",
  "required": ["$schema", "pirf_version", "rubi_version", "load_order", "license"],
  "additionalProperties": false,

  "properties": {

    "$schema": {
      "type": "string",
      "const": "rubi-integration-rules/v0.1",
      "description": "Schema version identifier. Per PIRF-F-004."
    },

    "pirf_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(-[a-zA-Z0-9.]+)?$",
      "description": "SemVer version of the PIRF format used. Per PIRF-N-001.",
      "examples": ["0.1.0", "0.1.0-draft"]
    },

    "rubi_version": {
      "type": "string",
      "description": "Version of the RUBI rule set this file set was converted from.",
      "examples": ["4.16.1", "5.0.0-dev"]
    },

    "license": {
      "type": "string",
      "description": "SPDX license identifier. Per PIRF-D-002.",
      "examples": ["MIT"]
    },

    "description": {
      "type": "string",
      "description": "Human-readable description of this rule set."
    },

    "rule_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of rules across all files."
    },

    "test_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Total number of test problems across all test files."
    },

    "load_order": {
      "type": "array",
      "description": "Ordered list of rule file paths (relative to this meta.json) defining the exact sequence in which files must be loaded. Order is semantically meaningful — it determines rule priority. Per PIRF-F-009a. Entries may be plain strings (file paths) or objects with a 'path' and optional 'requires' field for conditional loading.",
      "items": {
        "oneOf": [
          {
            "type": "string",
            "description": "Relative path to a rule JSON file. Prefix with '#' to comment out (disable). Per PIRF-F-009c.",
            "examples": [
              "1-algebraic/1.1-binomial/1.1.1-linear/1.1.1.1-(a+b-x)^m.json",
              "#8-special/8.10-bessel.json"
            ]
          },
          {
            "type": "object",
            "required": ["path"],
            "additionalProperties": false,
            "description": "Conditional load entry with feature flag requirement. Per PIRF-F-012a.",
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative path to a rule JSON file."
              },
              "requires": {
                "type": "string",
                "description": "Name of a feature flag in 'feature_flags' that must be true for this file to be loaded."
              }
            }
          }
        ]
      }
    },

    "feature_flags": {
      "type": "object",
      "description": "Boolean flags controlling conditional rule loading. Keys are flag names, values are defaults. Per PIRF-F-012a.",
      "additionalProperties": {
        "type": "boolean"
      },
      "examples": [
        {
          "load_elementary_function_rules": true,
          "load_show_steps": true,
          "load_bessel_functions": false
        }
      ]
    },

    "taxonomy": {
      "type": "array",
      "description": "The 9 top-level sections of the RUBI hierarchy with optional subsections. Per PIRF-T-001, PIRF-T-001a, PIRF-T-002.",
      "items": {
        "$ref": "#/definitions/taxonomy-entry"
      },
      "default": [
        { "section": 1, "title": "Algebraic functions" },
        { "section": 2, "title": "Exponentials" },
        { "section": 3, "title": "Logarithms" },
        { "section": 4, "title": "Trig functions" },
        { "section": 5, "title": "Inverse trig functions" },
        { "section": 6, "title": "Hyperbolic functions" },
        { "section": 7, "title": "Inverse hyperbolic functions" },
        { "section": 8, "title": "Special functions" },
        { "section": 9, "title": "Miscellaneous" }
      ]
    },

    "predicates": {
      "type": "array",
      "description": "List of all predicate names supported by this rule set. Loaders may use this to validate constraints. Per PIRF-F-012.",
      "items": {
        "type": "string"
      }
    },

    "utility_functions": {
      "type": "array",
      "description": "List of all utility function names that the Phrasebook must implement. Per PIRF-X-019, PIRF-P-022.",
      "items": {
        "type": "string"
      }
    },

    "extensions": {
      "type": "array",
      "description": "Custom operators beyond the PIRF-Expr core catalogue. Per PIRF-X-025.",
      "items": {
        "type": "object",
        "required": ["name", "arity"],
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[A-Z][a-zA-Z0-9$]*$",
            "description": "PascalCase operator name."
          },
          "arity": {
            "oneOf": [
              { "type": "integer", "minimum": 0 },
              { "type": "string", "pattern": "^[0-9]+-[0-9]+$" },
              { "type": "string", "pattern": "^[0-9]+\\+$" }
            ],
            "description": "Fixed arity (integer), range ('1-3'), or variadic ('2+')."
          },
          "semantics": {
            "type": "string",
            "description": "Informal description of the operator's meaning."
          }
        }
      }
    },

    "custom_predicates": {
      "type": "array",
      "description": "Custom predicates beyond the PIRF-C core catalogue. Per PIRF-C-040.",
      "items": {
        "type": "object",
        "required": ["name", "arity"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Predicate name."
          },
          "arity": {
            "oneOf": [
              { "type": "integer", "minimum": 1 },
              { "type": "string", "pattern": "^[0-9]+\\+$" }
            ],
            "description": "Fixed arity or variadic."
          },
          "semantics": {
            "type": "string",
            "description": "Informal description of the predicate's meaning."
          }
        }
      }
    },

    "converter": {
      "type": "object",
      "description": "Metadata about the tool that generated this rule set from Mathematica sources.",
      "properties": {
        "tool": { "type": "string" },
        "version": { "type": "string" },
        "source_commit": { "type": "string" },
        "converted_at": { "type": "string", "format": "date-time" }
      }
    }
  },

  "definitions": {
    "taxonomy-entry": {
      "type": "object",
      "required": ["section", "title"],
      "additionalProperties": false,
      "description": "A taxonomy section with optional nested subsections. Per PIRF-T-001, PIRF-T-002.",
      "properties": {
        "section": {
          "oneOf": [
            { "type": "integer", "minimum": 1 },
            {
              "type": "string",
              "pattern": "^[0-9]+(\\.[0-9]+)*$"
            }
          ],
          "description": "Section number: integer for top-level (1-9), dotted string for subsections (e.g. '1.1', '1.1.1', '4.3', '8.10')."
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "subsections": {
          "type": "array",
          "description": "Nested subsections within this section.",
          "items": {
            "$ref": "#/definitions/taxonomy-entry"
          }
        }
      }
    }
  }
}
